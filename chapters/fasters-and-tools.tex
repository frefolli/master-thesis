\chapter{The Extended SUMO-RL Framework}

This chapter introduces the SUMO-RL framework fork that has been developed to address the research questions.
SUMO-RL comprises a Core for running simulations and a toolchain for executing automated experiments and analyzing the results.

\section{The Core}

This section is concerned with the core of the reinforcement learning framework, containing software for implementing agents, functions and other enabling components.

\subsection{The Architecture}

SUMO-RL has a \textbf{modular} architecture (it can be seen in figure \ref{fig:sumo-rl-architecture}) that allows developers and researchers to replace a-la-carte almost all its components if needed.

The \textit{Environment} object gets created through settings supplied by both command line arguments and a configuration file.
These settings select which functions, agents, scenario to use in a simulation, as well as feature flags for tuning SUMO and changing other aspects of the experiments.
The Environment is then equipped with an \textit{ObservationFunction}, a \textit{RewardFunction}, a dataframe for collecting \textit{Metrics} about agents and the simulations, an object for caching data about vehicles, lanes and intersections called \textit{Datastore}, and a dictionary of \textit{TrafficSignal}s.
Each \textit{TrafficSignal} instance represents a controlled intersection in the scenario that has been loaded in the \textit{Environment}. Upon creation, it queries SUMO to extract valuable data about the shape of the intersection and the traffic light program logic (that is to say \textit{the clock cycle and its phases}). It identifies its \textit{green phases} and represents the act of switching to one of those as an action of the Action Space.

Along with the environment, also a set of \textit{Agent}s are created which can observe the state of the simulation through the output of the \textit{ObservationFunction} and get rewarded with the output of the \textit{RewardFunction}, both of which are mediated by the \textit{Environment}.

In most of literature works either there is only one intersection in the scenario or each agent instance is controlling only one of the intersections. As such, also the original SUMO-RL framework \cite{sumorl} developed by Lucas Alegre supported an agent to control only one traffic light intersection.
The architecture has been revised to allow agents to control more than one intersection by modifying both the agent trait and how the environment works.
In particular, SUMO-RL has been equipped with an algorithm for partitioning the set of controllable traffic lights intersections on the basis of the number of input lanes or the State Space shape.
By default, it assigns an distinct instance of agent to each one of the intersections in the network. If needed, it will group intersections based on the aforementioned similarities and assign a single agent instance for each group.
Furthermore, while the architecture allows for different agent types to act in the simulation at the same time, the system is actually instructed to use only one agent type at a time, because the goals of this research don't require to analyze the behaviour of different agent types on the same network.

\putimage{figures/sumo-rl-architecture.png}{The SUMO-RL architecture}{fig:sumo-rl-architecture}{1.0}

\subsection{The Environment}

%% TODO: inserire citazione a Gymnasium

\paragraph{Loading the scenario}

The Environment component, upon creation, starts a connection with SUMO loading the scenario that has been selected. Then, it queries SUMO for IDs of traffic lights and creates and instance of TrafficSignal for each one of them passing their ID and a copy of the connection with SUMO.
The TrafficSignal constructor also accepts parameters for changing the minimum green-light duration, the maximum green-light duration and the yellow-light duration.
This way, the TrafficSignal component is able to query SUMO for its shape and traffic light control program.
Therefore it acquires the list of incoming lanes, the list of output lanes and it caches the lengths of its lanes (which will be used afterwards in computations).
It also sets its \textit{Action Space} with a \textit{gymnasium}'s Discrete space which is parametrized on the number of green phases.
The action on a traffic light is the green phase it should enable, then its up to the TrafficSignal component to enforce that phase by using the correct yellow-light transition and the correct phase in the simulations.

\paragraph{Acquiring traffic light phases}

A TrafficSignal doesn't use the program hard-coded in the SUMO scenario but construct an appropriate program analyzing the hard-coded one.
It starts fetching all phases and filling an array \textit{green-phases} with all the phases which contain at least on of green-light encoding characters (\textit{"gG"}).
The green-phases are added also to the list of output \textit{phases}.
Then, it iterates on couples of sequential green phases to build the yellow phases which are a transition from a green phases $A$ and a green phase $B$. It essentially copies the phase of $A$ replacing all occurrences of green-light characters with the yellow-light character (\textit{"y"}).
It also keep a map \textit{yellow-dict} of transitions which can be indexed by a tuple of indices ($<i, j>$) and returns the corresponding yellow phase index.

\paragraph{Running the simulation}

Before running each simulation the environment should be reset through the \textit{reset()} method.
Every time it is reset, it reloads SUMO with the previously selected scenario, the selected routes file and the input seed (important for ensuring that a performed simulation is replicable).
At each iteration of a simulation, the agents are fed with the observations granted from the Environment and their actions are collected and fed in the Environment with its \textit{step()} method.
Afterwards, some other methods can be called depending of what data is needed. At least \textit{gather\_data\_from\_sumo()} and {compute\_observations()} are needed for running a simulation but using also \textit{compute\_rewards()} allows agents to learn and the researcher to investigate results. The \textit{gather\_data\_from\_sumo()} method essentially queries SUMO for data concerning vehicles and lanes so that it can extract the metrics enumerated in Tables \ref{tbl:gather-data-from-sumo-vehicle-metrics} and \ref{tbl:gather-data-from-sumo-lane-metrics}.

\begin{table}[H]
  \captionof{table}{Summary of Vehicle metrics collected by gather\_data\_from\_sumo().}
  \label{tbl:gather-data-from-sumo-vehicle-metrics}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|c|l|}
      \hline
      \textbf{ID}  & \textbf{Description} \\
      \hline
      awt & Accumulated Waiting Time is the amount of time of the last $1000$ seconds that a vehicle has spent being at full-stop. \\
      \hline
    \end{tabular}
  }
\end{table}

\begin{table}[H]
  \captionof{table}{Summary of Lane metrics collected by gather\_data\_from\_sumo().}
  \label{tbl:gather-data-from-sumo-lane-metrics}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|l|}
      \hline
      \textbf{ID}    & \textbf{Description} \\
      \hline
      lsvn  & LastStepVehicleNumber is the number of vehicles present in the lane in the last step of the simulation. \\
      \hline
      lshn  & LastStepHaltingNumber is the number of full-stop vehicles in the lane in the last step of the simulation. \\
      \hline
      lsms  & LastSteoMeanSpeed is the average speed of vehicles in the lane in the last step of the simulation. \\
      \hline
      lso   & LastStepOccupancy is the occupancy level in the lane in the last step of the simulation. \\
      \hline
      lswt  & LastStepWaitingTime is the average waiting time of vehicles in the lane in the last step of the simulation. \\
      \hline
      vehs  & LastStepVehicleIDs is the list of vehicles present in the lane in the last step of the simulation. \\
      \hline
      mawt  & the MeanAccumulatedWaitingTime is computed by averaging accumulated waiting times of vehicles in a lane. \\
      \hline
      tawt  & the TotalAccumulatedWaitingTime is computed by summing accumulated waiting times of vehicles in a lane. \\
      \hline
    \end{tabular}
  }
\end{table}

The \textit{compute\_observations()} method construct observations for each traffic light with the selected ObservationFunction and stores them inside an Environment field.
The \textit{compute\_rewards()} method constructs the rewards using the selected RewardFunction and stores them inside an Environment field.
The \textit{compute\_metrics()} method computes another set of metrics which are written to CSV files and can be analyzed to compute the performance of models as well as evaluating their fairness with respect of directions. This last option is available by setting to True a parameter called \textit{advanced\_metrics} which enables tracking the aforementioned metrics for each direction of the network (each pair of origin-destination inside the network).
This last set of metrics is enumerated in Table \ref{tbl:compute-metrics}.

\begin{table}[H]
  \captionof{table}{Summary of metrics collected by compute\_metrics().}
  \label{tbl:compute-metrics}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|l|}
      \hline
      \textbf{ID}                                 & \textbf{Description} \\
      \hline
      step                               & the current simulation step \\
      \hline
      total\_running                     & the number of vehicles which speed is not zero. \\
      \hline
      total\_backlogged                  & the number of vehicles which are enqueued and waiting to enter the simulation. \\
      \hline
      total\_stopped                     & the number of vehicles at full-stop. \\
      \hline
      total\_arrived                     & the number of vehicles which have arrived at their destination in the last step. \\
      \hline
      total\_departed                    & the number of vehicles which have departed in the last step (this is the same as \textit{entering the simulation}). \\
      \hline
      total\_waiting\_time               & the sum of waiting time of all lanes. \\
      \hline
      mean\_waiting\_time                & the mean of waiting time of all lanes. \\
      \hline
      total\_accumulated\_waiting\_time  & the sum of accumulated waiting time of all lanes. \\
      \hline
      mean\_accumulated\_waiting\_time   & the mean of accumulated waiting time of all lanes. \\
      \hline
      mean\_speed                        & the average of speed of all lanes. \\
      \hline
      total\_reward                      & the total of rewards released by the environment in the last step. \\
      \hline
    \end{tabular}
  }
\end{table}

\subsection{The Observation Functions}

The ObservationFunction class declares a trait (shown in Figure \ref{fig:observation-function-trait}) for a functor object which uses data from the \textit{Datastore} and the \textit{TrafficSignal}.
It supports quantization of continuous values to a configurable number of fixed levels. This operation is performed in conformity with equation \ref{eq:quantization}. By default, the number of levels is $16$, but this value can be changed by command line as needed and if it's set to zero, then no quantization is performed (this is useful for testing models with continuous spaces).
The State Space is defined by a $gymnasyum$'s Box of floating point values in range $[0, 1]$ of length \textit{observation\_space\_size()}.

\putimage{figures/observation-function-trait.png}{The ObservationFunction class/trait}{fig:observation-function-trait}{0.75}

In Table \ref{tbl:observation-features} the features which can be extracted for composing the observation of an agent are listed and detailed.
Moreover, a \textit{shared-view} mechanism has been implemented so that a traffic light agent can see not only its state through a observation function (called "me-function") but also a view over its neighbour traffic lights through a second observation function (called "you-function").
The shared-view is implemented with a cache so that the observation of a traffic light isn't computed two or more times for each time step.
Each agent has a owned observation and if the shared-view is active, then it imports in the resulting observation also the owned observation of neighbour agents.

It was chosen not to include output lane information in the observable features in order to keep the state space small. Literature works on the same topic usually keep this convention and adopts similar state features \cite{wei2019presslight} \cite{han2023leveraging}. The novelty is the inclusion of neighbour data, which also makes up for the lack of output lane data since a output lane of a intersection A can be an input lane of a neighbour intersection B.

In Table \ref{tbl:observation-functions} the available configurations for observation functions are listed by what features they allow the agent to see and if they are \textit{shared-views}. The output State Space shape is also displayed assuming that a traffic light agent has $N$ phases, $M$ incoming lanes and $K$ neighbours.
The reason behind the choice of using the Density ("d") observation function as base for the shared-views will be more clear in the next chapter.

\begin{table}[H]
  \captionof{table}{Summary of implemented observation features}
  \label{tbl:observation-features}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|l|l|c|}
      \hline
      \textbf{Name} & \textbf{ID} & \textbf{Description} & \textbf{Formula} \\
      \hline
      Current Phase Encoding     & \textbf{CPE} & \makecell[l]{the current traffic light phase ($CP$) encoded as one-hot vector.} &
      \makecell{$
        CPE = \left<
          \left\{
          \begin{array}{cl}
            1 & CP = P_i \\
            0 & CP \ne P_i
          \end{array}
          \right\}
          | \; \forall i \in [0, N)
        \right>
      $} \\
      \hline
      Minumum Green Time Reached & \textbf{MGR} & \makecell[l]{a boolean value which is $1$ if and only if the time since \\
                                                               when the traffic light completed a phase change ($TSLC$) has surpassed \\
                                                               the environment configured minimum green time ($MGT$).} &
      \makecell{$
        MGR = \left\{
          \begin{array}{cl}
            1 & TSLC > MGT \\
            0 & TSLC \leq MGT
          \end{array}
        \right\}
      $} \\
      \hline
      Lane Speed Percentage      & \textbf{LSP} & \makecell[l]{for each lane the average speed ($S(v)$) of vehicles in it ($V(L_i)$) is \\
                                                               divided by the maximum allowed speed on such lane ($MAS(L_i)$).} &
      \makecell{$LSP = \left< \frac {\sum _ {v \in V(L_i)} S(v)} {|V(L_i)| \; \cdot \; MAS(L_i)} \; | \; \forall i \in [0, M) \right>$} \\
      \hline
      Lane Occupancy             & \textbf{LOC} & \makecell[l]{for each lane, the percentage of its occupancy \\
                                                               is retrieved from SUMO. It is equivalent to summing \\
                                                               the lengths ($|v|$) of vehicles in a lane ($V(L_i)$) \\
                                                               divided by the length of that lane ($|L_i|$)} &
      \makecell{$LOC = \left< \frac {\sum _ {v \in V(L_i)} |v|}  {|L_i|} \; | \; \forall i \in [0, M) \right>$} \\
      \hline
      Lane Queuing Percentage    & \textbf{LQP} & \makecell[l]{for each lane, its occupancy ($LOC_i$) is multiplied by \\
                                                               the number of vehicles in such lane being at full-stop ($FSV(L_i)$) \\
                                                               and divided by the number of vehicles in that lane ($V(L_i)$).} &
      \makecell{$LQP = \left< \frac{{LOC}_i \; \cdot \; |FSV(L_i)|} {|V(L_i)|} \; | \; \forall i \in [0, M) \right>$} \\
      \hline
    \end{tabular}
  }
\end{table}

\begin{table}[H]
  \captionof{table}{Summary of implemented observation functions}
  \label{tbl:observation-functions}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|c|c|c|c|c|c|c|c|c|c|c|}
      \hline
      \textbf{ID} & \multicolumn{5}{|c|}{\textbf{Itself}} & \multicolumn{5}{|c|}{\textbf{Neighborhood}} & \textbf{State Space Shape} \\
      \hline
      & \textbf{CPE} & \textbf{MGR} & \textbf{LSP} & \textbf{LOC} & \textbf{LQP} & \textbf{CPE} & \textbf{MGR} & \textbf{LSP} & \textbf{LOC} & \textbf{LQP} & \\
      \hline
      default & \FilledCircle & \FilledCircle & \FilledCircle & \FilledCircle & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & ${[0,1]} ^ {log _ 2 {N} + 1 + 3 \cdot M}$ \\
      \hline
      s       & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & ${[0,1]} ^ {M}$ \\
      \hline
      d       & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & ${[0,1]} ^ {M}$ \\
      \hline
      q       & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & ${[0,1]} ^ {M}$ \\
      \hline
      sv      & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \FilledCircle & \FilledCircle & \FilledCircle & \FilledCircle & \FilledCircle & ${[0,1]} ^ {log _ 2 {N} + 1 + (3 + K) \cdot M}$ \\
      \hline
      svs     & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & ${[0,1]} ^ {(K + 1) \cdot M}$ \\
      \hline
      svp     & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & ${[0,1]} ^ {(K + 1) \cdot M}$ \\
      \hline
      svd     & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & ${[0,1]} ^ {(K + 1) \cdot M}$ \\
      \hline
      svq     & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & ${[0,1]} ^ {(K + 1) \cdot M}$ \\
      \hline
    \end{tabular}
  }
\end{table}

\subsection{The Reward Functions}

The RewardFunction class declares a trait (shown in Figure \ref{fig:reward-function-trait}) for a functor object which uses data from the \textit{Datastore} and the \textit{TrafficSignal}.

\putimage{figures/reward-function-trait.png}{The RewardFunction class/trait}{fig:reward-function-trait}{0.75}

In Table \ref{tbl:reward-features} the features which can be extracted for composing the reward of an agent are listed and detailed.
Moreover, a \textit{shared-view} mechanism has been implemented so that a traffic light agent can be rewarded also with its neighbour rewards.
The shared-view is implemented with a cache so that the reward of a traffic light isn't computed two or more times for each time step.
Each agent has a owned reward and if the shared-view is active, then it imports in the resulting reward also the owned reward of neighbour agents.

The DWT measures how much the accumulated waiting time has decreased. If $DWT > 0$ then the accumulated waiting time is lower than before and it delivers a positive reward.

The SPD measures if vehicles are flowing at a higher speed than half the maximum allowed speed. Intuitively, if this quantity is positive, then it leads to a positive reward.

The QLE without negative sign would be non-negative number. Since its measuring the amount of halted vehicles, a negative reward is released when the absolute value of this quantity is greater then 0. This way, the agents will minimize the length of queues in controlled lanes.
Moreover, since DQL is using QLE are reference, it doesn't need to be inverted.

Finally, PRE is based on the concept of Pressure \cite{wei2019presslight}, which expresses the disequilibrium between the outcoming flow and the incoming flow.
The original formula, shown in equation \ref{eq:original-pressure}, was the difference of incoming and outcoming vehicles ($V(L_i)$) weighted by the capacity of lanes ($LC(L_i)$), which in PRE has been simplified by removing the divisions and inverting the involved quantities to deliver a positive reward whenever the outcoming flow surpasses the incoming flow.
Intuitively this means that the number of vehicles which have passed the intersection is higher than the one of queued and incoming vehicles.
More will be said in the following sections about how the capacity of a road can be calculated, but in the present research I'm assuming that all lanes have similar capacity due to the fact that the context is urban tissue which usually have $30-50$ km/h speed limits on the whole road network.

In Table \ref{tbl:reward-functions} the available configurations for reward functions are listed by what features are used and if they are \textit{shared-views}. The output Reward Space shape is also displayed assuming that a traffic light agent has $N$ incoming lanes, $M$ outcoming lanes and $K$ neighbours.
The reason behind the choice of using the DiffWaitingTime ("dwt") reward function as base for the shared-views will be more clear in the next chapter.

\begin{table}[H]
  \captionof{table}{Summary of implemented reward features}
  \label{tbl:reward-features}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|l|l|c|}
      \hline
      \textbf{Name} & \textbf{ID} & \textbf{Description} & \textbf{Formula} \\
      \hline
      Diff Accumulated Waiting Time  & \textbf{DWT} & \makecell[l]{the difference between the total accumulated waiting time ($TAWT$) \\
                                                                   of vehicles in its input lanes in the previous time step and the TAWT \\
                                                                   in the current time step. The DWT is divided by 100 to avoid unstable \\
                                                                   rewards due to the TAWT having an upper bound of $1000$.}
                                                    & \makecell{$ \frac {{TAWT}_{t-1} - {TAWT}_{t}} {100} $} \\
      \hline
      Average Speed                  & \textbf{SPD} & \makecell[l]{the mean of average speeds of vehicles in its input lanes $AS(L_i)$ \\
                                                                   divided by the maximum allowed speed ($MAS(L_i)$) minus $\frac {1} {2}$.}
                                                    & \makecell{$\sum _ {i \in [0, N)} \frac {AS(L_i)} {MAX(L_i)} - \frac {1} {2}$} \\
      \hline
      Queue Lengths                  & \textbf{QLE} & \makecell[l]{the mean of length of queues (as number of full-stop vehicles $FSV(L_i)$) \\
                                                                   in its input lanes multiplied by $-1$.}
                                                    & \makecell{$- \frac {\sum _ {i \in [0, N)} FSV(L_i)} {N}$} \\
      \hline
      Diff Queue Lengths             & \textbf{DQL} & \makecell[l]{the difference between the QLE in the current time step and \\
                                                                   the QLE in the previous \\ time step.} & \makecell{${QLE}_{t} - {QLE}_{t-1}$} \\
      \hline
      Pressure                       & \textbf{PRE} & \makecell[l]{for each lane, the negative pressure is defined as the difference between \\
                                                                   the number of outcoming vehicles and the number of incoming vehicles}
                                                                   & \makecell{$P = \left[ \sum _ {i \in [0, N)} V(L_i) \right] - \left[ \sum _ {i \in [0, M)} V(L_i) \right]$} \\
      \hline
    \end{tabular}
  }
\end{table}

\begin{equation} \label{eq:original-pressure}
  P =
  \left[ \sum _ {i \in [0, N)} \frac {V(L_i)} {LC(L_i)} \right]
  -
  \left[ \sum _ {i \in [0, M)} \frac {V(L_i)} {LC(L_i)} \right]
\end{equation}

\begin{table}[H]
  \captionof{table}{Summary of implemented reward functions}
  \label{tbl:reward-functions}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|c|c|c|c|c|c|c|c|c|c|}
      \hline
      \textbf{ID} & \multicolumn{5}{|c|}{\textbf{Itself}} & \multicolumn{5}{|c|}{\textbf{Neighborhood}} \\
      \hline
      & \textbf{DWT} & \textbf{SPD} & \textbf{QLE} & \textbf{DQL} & \textbf{PRE} & \textbf{DWT} & \textbf{SPD} & \textbf{QLE} & \textbf{DQL} & \textbf{PRE} \\
      \hline
      dwt   & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  \\
      \hline
      as    & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  \\
      \hline
      ql    & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  \\
      \hline
      dql   & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  \\
      \hline
      p     & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  \\
      \hline
      svdwt & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  \\
      \hline
      svas  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  \\
      \hline
      svql  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  \\
      \hline
      svdql & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  \\
      \hline
      svp   & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \EmptyCircle  & \FilledCircle \\
      \hline
    \end{tabular}
  }
\end{table}

\subsection{The Agents}

The Agent class declares a trait (shown in Figure \ref{fig:agent-trait}) for an object which can accepts observations, take actions, learn from errors, be serialized and deserialized. Agents only need to support at least the \textit{act()} method, the other methods are optional. For example, a fixed cycle agent won't learn nor observe the environment, it will just act.

\putimage{figures/agent-trait.png}{The Agent class/trait}{fig:agent-trait}{0.75}

Agents with various features have been implemented in order to compare the effectiveness of those approaches. Among the learning agents, there are three tabular agents and two neural network based agents. Most of them use an off-policy strategy but SARSA which is on-policy. Moreover, the two neural agents support also continuous state space and even if generally quantization will be used in experiments, an interesting point is verifying if not using quantization leads to advantages or disadvantages in performance. Furthermore, the size of neural networks is fixed to $32$ nodes per layer since an objective is to keep all the models reasonably small \footnote{If a traffic light agent needs a supercomputer sized neural network, then it's probably cheaper to build a roundabout or a tramway...}.
Finally, the neural models use a buffer which accumulates examples taken from interacting with the environment and every time it's full they use it to learn. The examples are essentially State-Action-Reward tuples.

An important notice is that all the reinforcement learning agents are non deterministic. The neural models use their output layer as a probability distribution in order to pick an action according to its probability (i.e. its expected reward). Instead, the tabular methods use the Epsilon Greedy strategy with a minimum value of $0.05$, which means that approximately $5\%$ of the actions will be randomized. Lowering this value leads to a more deterministic behaviour, but it has been empirically proven that a little of non-determinism does improve performance ratings for all models.

The agents \textit{fixed15}, \textit{fixed30}, \textit{fixed45}, \textit{fixed60} do not learn. Instead, they follow a fixed cycle algorithm, switching phase every $k$ seconds.
Those are the baseline for comparing RL algorithms with the currently employed system. Since all agents start synchronized in the same phase, they are operated in \textit{green wave} mode.

Table \ref{tbl:agents} shows a summary of all implemented agents.

\begin{table}[H]
  \captionof{table}{Summary of implemented agents}
  \label{tbl:agents}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|l|c|l|l|l|c|c|c|}
      \hline
      \textbf{ID}      & \textbf{Agent Type}  & \textbf{Cycle Time} & \textbf{Learning Algorithm}           & \textbf{Learning Method} & \textbf{Learning Policy} & \textbf{NN Size} & \textbf{Buffer Size} & \textbf{$\epsilon$-Greedy} \\
      \hline
      fixed15 & Fixed Cycle & 15 secs    & \xmark                       & \xmark          & \xmark          & \xmark  & \xmark      & \xmark \\
      \hline
      fixed30 & Fixed Cycle & 30 secs    & \xmark                       & \xmark          & \xmark          & \xmark  & \xmark      & \xmark \\
      \hline
      fixed45 & Fixed Cycle & 45 secs    & \xmark                       & \xmark          & \xmark          & \xmark  & \xmark      & \xmark \\
      \hline
      fixed60 & Fixed Cycle & 60 secs    & \xmark                       & \xmark          & \xmark          & \xmark  & \xmark      & \xmark \\
      \hline
      sarsa   & RL Agent    & \xmark     & SARSA                        & Tabular         & On-Policy       & \xmark  & \xmark      & $\epsilon \in [0.05, 1.0] \; \; decay = 0.99$ \\
      \hline
      ql      & RL Agent    & \xmark     & Q Learning                   & Tabular         & Off-Policy      & \xmark  & \xmark      & $\epsilon \in [0.05, 1.0] \; \; decay = 0.99$ \\
      \hline
      dql     & RL Agent    & \xmark     & Double Q Learning            & Tabular         & Off-Policy      & \xmark  & \xmark      & $\epsilon \in [0.05, 1.0] \; \; decay = 0.99$ \\
      \hline
      dqn     & RL Agent    & \xmark     & Deep Q Networks              & Neural          & Off-Policy      & 32x32   & 2048        & \xmark \\
      \hline
      ppo     & RL Agent    & \xmark     & Proximal Policy Optimization & Neural          & Off-Policy      & 32x32   & 2048        & \xmark \\
      \hline
    \end{tabular}
  }
\end{table}

\subsection{A Self-Adaptive algorithm}

SUMO-RL has been equipped with a Self-Adaptive mechanism which allocates a small training time slot if performance degrades over time.
The objective of this algorithm is to be effective yet not invasive, therefore it has been designed to trigger only when performance differs significantly.

If Self-Adaptive is enabled, during the training process, SUMO-RL tracks some of the performance metrics (e.g. mean\_accumulated\_waiting\_time, mean\_waiting\_time, mean\_speed) in order to be able to compare them during the evaluation process (which is supposed to be production-like).

During the evaluation phase, every $K = 10000$ seconds, the algorithm computes the performance metrics and compared them with the one tracked during training.
If one of the performance metrics differs of more than $5\%$ from the consolidated mean, then a training slot is allocated.
After a training slot, the algorithm is instructed not to activate for at least $T = 30000$ seconds.

\section{The Tools}

This section showcases and explains the tools that have been developed as support for operating the SUMO-RL Core and carrying out simulations.
These modules include traffic generation, cross format conversions, experiments execution and run analysis.

\subsection{Importing from external sources}

\paragraph{The AMAT format}

Agenzia Mobilit\`a Ambiente Territorio (AMAT) publishes an Origin Destination matrix for the Municipality of Milan along side a graph representation of the road network infrastructure \cite{ODMilano2010}.
While the graph representation of Milan road network is too big to be used by a consumer-level commodity equipment, the format used by AMAT is interesting because it enables to reuse realistic data coming directly from mobility authorities into SUMO.
While other authorities may use different fields or tables, the DBF/SHP file formats are commonly used when dealing with labelled geographic data and with many sources like OpenStreetMap this format can be used to export data.

The road graph is composed multiple files: a SHP file for the nodes, a SHP file for graph and a DBF file for priorities and turn restrictions.
These files are essentially relational databases, which content is summarized in Tables \ref{tbl:amat-nodes-file}, \ref{tbl:amat-graph-file} and \ref{tbl:amat-turns-file}.
Note that both SHP and DBF files can be converted to SQLite3 file format which is easier to use.

The coordinates of nodes are Gauss-Boaga projections which is a map project method widely used in Italy. Those coordinates can be kept as are and mapped 1:1 to a canvas grid since they may only need scaling to adjust distances.
Usually transit simulators assume to use the metric system for unit of measures, therefore speeds and distances should be converted to m/s and m respectively.

Moreover, the AMAT format doesn't specify the number of lanes and that datum have to be inferred from \textit{Linktype} or Speed/Capacity.
Since the Milan road network uses different traffic light cycles in different zones and those are not known, the choice was to use Linktype.

Usually, in Milan and in Italy, freeways may have $4$ lanes per side, main roads may have $3$ lanes per side, secondary roads may have $2$ lanes per side and finally local roads have $1$ lane per side.
If this convention is used to infer the number of lanes, the extracted road network shows similar features to the real infrastructure, as shown in the comparison of Figures \ref{fig:gmaps-asturie-testi-la-farina} and \ref{fig:sumo-asturie-testi-la-farina}.

\begin{table}[H]
  \captionof{table}{Fields of Nodes SHP file}
  \label{tbl:amat-nodes-file}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|l|l|}
      \hline
      \textbf{Field} & \textbf{Description}                                                & \textbf{Notes} \\
      N     & Each node in the graph is identified by a unique numeric ID &       \\
      X     & Longitude coordinate in Gauss-Boaga (m) format             &       \\
      Y     & Latitude coordinate in Gauss-Boaga (m) format              &       \\
      \hline
    \end{tabular}
  }
\end{table}

\begin{table}[H]
  \captionof{table}{Fields of Graph SHP file}
  \label{tbl:amat-graph-file}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|l|l|}
      \hline
      \textbf{Field}     & \textbf{Description}                                                      & \textbf{Notes}                                                                               \\
      \hline
      ID        & Each edge in the graph is also identified by a unique numeric ID &                                                                                     \\
      \hline
      A         & Source node ID                                                   & Valid IDs are found in the Nodes file                                               \\
      \hline
      B         & Source node ID                                                   & Valid IDs are found in the Nodes file                                               \\
      \hline
      Distance  & Length of the edge from A to B                                   & Values in km                                                                        \\
      \hline
      Linktype  & Type of road edge                                                & \makecell[l]{1 = Freeway \\ 2 = Main Road \\ 3 = Secondary Road \\ 4 = Local Road}  \\
      \hline
      Speed     & Maximum allowed speed in the road edge                           & Values in km/h                                                                      \\
      \hline
      Capacity  & \makecell[l]{
                  Road capacity which is computed upon speed, number of lanes \\
                  and traffic light green-time/cycles ratio}                       & Values in number of vehicles                                                        \\
      \hline
    \end{tabular}
  }
\end{table}

\begin{table}[H]
  \captionof{table}{Fields of Turns DBF file}
  \label{tbl:amat-turns-file}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|l|l|}
      \hline
      \textbf{Field}   & \textbf{Description}                                                & \textbf{Notes}                                             \\
      \hline
      A       & Source node of the incoming edge (A-B)                     &                                                   \\
      \hline
      B       & Intersection node                                          &                                                   \\
      \hline
      C       & Sink node of the outcoming edge (B-C)                      &                                                   \\
      \hline
      Penalty & Priority is expressed as penalty in minutes $p \times 100$ & Penalty = $-1$ means that the turn is not allowed \\
      \hline
    \end{tabular}
  }
\end{table}

\putimagecouple
{\putsubimage{figures/gmaps-asturie-testi-la-farina.png}{Intersection of via Asturie, via Testi and via La Farina in Milan. Source: Google Maps}{fig:gmaps-asturie-testi-la-farina}{0.45}{1.0}}
{\putsubimage{figures/sumo-asturie-testi-la-farina.png}{A reconstruction of the intersection with the AMAT data}{fig:sumo-asturie-testi-la-farina}{0.45}{1.0}}

The Origin Destination matrix is given as multiple files representing a different time range (summarized in Table \ref{tbl:amat-time-ranges}).
Each file is in DBF format (but it can be converted to SQLite3 as before) and contains data about all vehicle transits between zones of Milan.
Those zones are enumerated in a different file alongside their borders (usually squared).
The schema of a OD file is detailed in Table \ref{tbl:amat-od-file}.

The number of vehicles specified by an entry of an OD file must be scaled with the \textit{Expansion Coefficient} which accounts for the fact that time ranges have different length.
AMAT distinguishes demand by travel reason, which in simulations may not be so useful, therefore those values are combined together to obtain the total demand.
Moreover, simulation engines like SUMO and CityFlow usually require TAZs to specify which roads to affect, therefore geographic location data from the road graph must be combined with the one for zones to build such mapping.

\begin{table}[H]
  \captionof{table}{Times ranges tracked by AMAT}
  \label{tbl:amat-time-ranges}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|c|c|l|}
      \hline
      \textbf{Time Range}    & \textbf{Expansion Coefficient} & \textbf{Identified Phase} \\
      \hline
      07:00 - 10:00 & 2.33                  & Morning peak     \\
      \hline
      10:00 - 16:00 & 6.00                  & Off-peak         \\
      \hline
      16:00 - 20:00 & 3.52                  & Evening peak     \\
      \hline
    \end{tabular}
  }
\end{table}

\begin{table}[H]
  \captionof{table}{Content schema of a OD file}
  \label{tbl:amat-od-file}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|l|l|}
      \hline
      \textbf{Field}     & \textbf{Description}                & \textbf{Notes}                                                                                                 \\
      \hline
      orig\_urb  & Source zone                & Valid IDs are found in the Zones file                                                                 \\
      \hline
      dest\_urb  & Sink zone                  & Valid IDs are found in the Zones file                                                                 \\
      \hline
      cd\_motivo & Reason of travel           & \makecell[l]{LAV = Work \\ AFF = Business \\ ALT = Study or other reasons \\ CAS = Returning to home} \\
      \hline
      veq\_priv  & Number of counted vehicles &                                                                                                       \\
      \hline
    \end{tabular}
  }
\end{table}

\paragraph{The CityFlow format}

Since CityFlow is another commonly used simulator, it is important to understand its file format in order to be able to reuse existing scenarios from the literature and experiment on variations.
CityFlow uses two files for network and demand.
The network file specifies intersections and roads while the demand file specifies vehicle trips.

A dead end node is a virtual intersection which can be declared with an ID, a position, the roads for which it is source or sink.
The schema requires setting the \textit{virtual} attribute to true and adding stubs for unused fields like \textit{roadLinks} and \textit{trafficLight}.
An example of virtual intersection is shown in Listing \ref{lst:sumo-virtual-intersection}.

\noindent
\begin{minipage}{\linewidth}
\begin{lstlisting}[language=JSON, caption=Example of virtual intersection declaration in CityFlow format, label={lst:cityflow-virtual-intersection}]
{
  "id": "J0",
    "point": {
      "x": -300,
      "y": 0
    },
    "width": 0,
    "roads": [
      "E1"
    ],
    "roadLinks": [],
    "trafficLight": {
      "roadLinkIndices": [],
      "lightphases": []
    },
    "virtual": true
}
\end{lstlisting}
\end{minipage}

A normal intersection is more complex as it contains some \textit{roadLinks} which are internal links between roads for which the intersection is source or sink.
The same goes for \textit{laneLinks}, which are links between lanes of the same roadLink.
Finally, the traffic light program is declared directly inside the intersection object with an enumeration of roadLinks and a list of phases with duration and green-light roadLinks.
All the roadLinks not listed inside a phase are automatically set to red-light.
Yellow-light links are not declarable directly in CityFlow.

An example of normal intersection is shown in Listing \ref{lst:sumo-normal-intersection}.

\noindent
\begin{minipage}{\linewidth}
\begin{lstlisting}[language=JSON, caption=Example of normal intersection declaration in CityFlow format, label={lst:cityflow-normal-intersection}]
{
  "id": "J1",
  "point": {"x": 0, "y": 0},
  "width": 11,
  "roads": ["E1", "E2", "E3", "E4"],
  "roadLinks": [{
    "type": "go_straight",
    "startRoad": "E1",
    "endRoad": "E2",
    "direction": 0,
    "laneLinks": [{
      "startLaneIndex": 0,
      "endLaneIndex": 0,
      "points": [{"x": -5.0, "y": 0.0},
                 {"x":  5.0, "y": 0.0}]
    }]
  },...],
  "trafficLight": {
    "roadLinkIndices": [0, ...],
    "lightphases": [{
      "time": 30,
      "availableRoadLinks": [
        0,...
      ]
    },...]
  },
  "virtual": false
},
\end{lstlisting}
\end{minipage}

The Road object is very simple and declares an ID, a shape, the set of lanes with width and maximum allowed speed, source and sink intersections.
An example of Road is shown in Listing \ref{lst:cityflow-road}.

\noindent
\begin{minipage}{\linewidth}
\begin{lstlisting}[language=JSON, caption=Example of road declaration in CityFlow format, label={lst:cityflow-road}]
{
  "id": "E1",
  "points": [{"x": -300, "y": 0},
            {"x": 0, "y": 0}],
  "lanes": [{"width": 3, "maxSpeed": 13.89}],
  "startIntersection": "J0",
  "endIntersection": "J1"
}
\end{lstlisting}
\end{minipage}

Finally, vehicle trips can be declared by specifying the vehicle features, its route in terms of roads, in time data such as start/end time and interval between spawns. If the end time is greater than the start time, then this object behaves like a flow, otherwise it behaves like a single trip.
An example of vehicle trips and routes is shown in Listing \ref{lst:cityflow-vehicle-trip}.

\noindent
\begin{minipage}{\linewidth}
\begin{lstlisting}[language=JSON, caption=Example of vehicle trip and route declaration in CityFlow format, label={lst:cityflow-vehicle-trip}]
{"vehicle": {"length": 5.0,
             "width": 2.0,
             "maxPosAcc": 2.0,
             "maxNegAcc": 4.5,
             "usualPosAcc": 2.0,
             "usualNegAcc": 4.5,
             "minGap": 2.5,
             "maxSpeed": 11.111,
             "headwayTime": 2},
 "route": ["E1 E2 E3"],
 "interval": 1.0,
 "startTime": 0,
 "endTime": 0}
{"vehicle": {...},
 "route": ["E1 E2 E3"],
 "interval": 1.0,
 "startTime": 0,
 "endTime": 3600}
\end{lstlisting}
\end{minipage}

\paragraph{The SUMO format}

As explained in the second chapter, also SUMO uses different files for network, demand and various other objects.
The network file specifies junctions (intersections and dead ends), traffic light programs, edges and other kind of links.
The routes file specifies vehicle trips, routes and flows.

The declaration of a virtual Junction only involves setting an ID, the proper \textit{type} attribute, the coordinates and the incoming lanes.
An example of virtual junction is shown in Listing \ref{lst:sumo-virtual-intersection}.

\noindent
\begin{minipage}{\linewidth}
\begin{lstlisting}[language=XML, caption=Example of virtual Intersection declaration in SUMO format, label={lst:sumo-virtual-intersection}]
<junction id="J0" type="dead_end" x="-300" y="0" incLanes="-E1" intLanes=""/>
\end{lstlisting}
\end{minipage}

A normal intersection instead requires also the declaration of the internal lanes and the Request objects.
The requests regulate priorities for the intersection while the internal lanes are links from the incoming lanes to the intersection. To map the intersection back to the outcoming lanes a Connection object is used.
A Connection object is also labelled with a \textit{linkIndex} which is then used in traffic light program entries to define which links are set to green/yellow/read.
A traffic light program can be declared by using a TLLogic object which requires only the program ID, the junction to which is applied and a list of phases with duration and state.
An example of normal junction is shown in Listing \ref{lst:sumo-normal-intersection}.

\noindent
\begin{minipage}{\linewidth}
\begin{lstlisting}[language=XML, caption=Example of normal Intersection declaration in SUMO format, label={lst:sumo-normal-intersection}]
<junction id="J1" type="traffic_light"
          x="0.0" y="0.0"
          incLanes="E1 -E2 ..."
          intLanes=":J1_0_1 ...">
  <request index="0" response="10" foes="10" cont="0"/>
  <request index="1" response="00" foes="01" cont="0"/>
</junction>
<connection from="E1" to="E2"
            fromLane="0" toLane="0"
            via=":J1_0_0" tl="J1"
            linkIndex="0" dir="r"
            state="O"/>
...
<connection from=":J1_0" to="E2"
            fromLane="0" toLane="0"
            dir="r" state="M"/>
...
\end{lstlisting}
\end{minipage}

\noindent
\begin{minipage}{\linewidth}
\begin{lstlisting}[language=XML, caption=Example of traffic light program declaration in SUMO format, label={lst:sumo-traffic-light-program}]
<tlLogic id="J1" type="static" programID="0" offset="0">
  <phase duration="42" state="GGgrrrGGgrrr"/>
  ...
</tlLogic>
\end{lstlisting}
\end{minipage}

The Edge object (a road) is rather simple. It declares an ID, source and sink junctions, a priority value, the alignment of lanes on the road (e.g. center, right), a shape and its lanes.
The Lane object is declared as a child of an Edge and has an ID, an index, a maximum allowed speed, a virtual length and other parameters.
An example of Edge with Lanes is shown in Listing \ref{lst:sumo-edge-lane}.

\noindent
\begin{minipage}{\linewidth}
\begin{lstlisting}[language=XML, caption=Example of Edge declaration in SUMO format, label={lst:sumo-edge-lane}]
<edge id="E1" from="J0"
      to="J1" priority="1"
      spreadType="center" shape="-300,0 0,0">
  <lane id="E1_0" index="0" speed="13.89" length="300"/>
</edge>
\end{lstlisting}
\end{minipage}

In SUMO, a vehicle can be declared to use a custom route or reuse an already defined route.
The data required to spawn trips or flows are similar to the one needed in SUMO.
In particular, in SUMO it is also possible to use junctions as waypoints for a route.
An example of vehicle trips and routes is shown in Listing \ref{lst:sumo-vehicle-trip}.

\noindent
\begin{minipage}{\linewidth}
\begin{lstlisting}[language=XML, caption=Example of vehicle trip and route declaration in SUMO format, label={lst:sumo-vehicle-trip}]
<route id="r_0" edges="E1 E2 E3"/>
<vehicle id="v_0" depart="0.00" route="r_0"/>
<flow id="f_0" begin="0.00"
      fromJunction="J0" toJunction="J1"
      end="3600.00" vehsPerHour="1800"/>
\end{lstlisting}
\end{minipage}

\paragraph{The converters}

Given that all the format discussed above involve the same semantic entities (roads, intersections, traffic light programs), it is fairly easy to convert them one into another.
In SUMO-RL three utilities have been implemented for the following conversions:

\begin{itemize}
  \item \textbf{cityflow2sumo}: converts CityFlow networks+demands to SUMO
  \item \textbf{amat2cityflow}: converts AMAT networks+demands to CityFlow
  \item \textbf{amat2sumo}: converts AMAT networks+demands to SUMO
\end{itemize}

\subsection{Generating traffic}

A module called \textbf{generate-flows} has been implemented to allow generating traffic data from a given network.
It reads the input network in SUMO format and a description of \textit{axes}, which are the main directions of the network.
For instance, consider the scenario in Figure \ref{fig:setting-breda} presented in the first chapter.
In this example, the main axis is \textit{J0 <-> J3} and the side axes are \textit{J4 <-> J5} and \textit{J6 <-> J7}.
Moreover, if $A \leftrightarrow B$ as a \textit{main/side} axis, then $A$,$B$ are considered \textit{main/side} nodes.
This definition will be useful when declaring traffic levels.

\paragraph{Computing network capacity}

The network is also analyzed in order to extract relevant metrics such as the ideal capacity of roads.
The formula for computing a road capacity is fairly simple. As shown in Equation \ref{eq:road-capacity}, the capacity is the inverse of the headway time $HT$, which is the time separation between two vehicles.

\begin{equation} \label{eq:road-capacity}
  RC = \frac {1} {HT}
\end{equation}

The headway time can then be computed as in Equation \ref{eq:headway-time} using the average vehicle length $VL$, the minimum vehicle following distance $MG$ and the maximum allowed speed $MS$.
Also, a dumping coefficient is used to simulate the effects of conflicts at intersections. Here, $\tau = 3.0$.

\begin{equation} \label{eq:headway-time}
  HT = \tau \frac {VL + MG} {MS}
\end{equation}

The capacity values of each lane/road get summed to obtained the approximated instant capacity of the network and such value gets multiplied by $3600$ to obtain an approximation of the hourly capacity of the network.

\paragraph{The traffic types}

This module can generate traffic configuration using \textit{four} base types as building blocks.
In particular, each of those traffic bricks has a duration which will be referred to as \textit{block time} and the combination of more traffic bricks has the sum of their durations as block time.

The \textit{Random} type is generated by dividing the block time into time slots of fixed size in which each direction has a binomial probability of appearing ($p=0.7$).
With the \textit{Stable} type, the traffic level on each direction doesn't changes significantly during the block time.
The \textit{Unstable} types divides the block time into time slots of dixed size in which traffic in side directions may appear ($p=0.7$).
Finally, the \textit{Transition} type concatenates multiple traffic types $T_1, T_2, ... T_n$ into a single block time in which traffic changes between those types every $k$ seconds. In particular, if the block time is $BT$ and the number of input traffic types is $N$, then each child traffic type is assigned $\frac {BT} {N}$ seconds.

In addition to this classification, other options are employed to customize the traffic configuration.
The traffic types are summarized in Table \ref{tbl:traffic-types} along with the options they support.

The option \textit{Symmetry} decides if a direction and its opposite have to receive the same traffic load. Its values are Symmetric/Asymmetric.
The option \textit{Density} decides whether to generate traffic only on declared axis or also in all other directions. Its values are Axial/Dense.
The option \textit{Direction} decides which of the two direction (direct and inverted one) will receive more traffic (double the amount) if $Symmetry \; = \; Asymmetric$. Its values are Direct/Inverse.
The option \textit{TrafficLevel} defines the traffic level as a decimal value representing the percentage of vehicles to be generated in a flow with respect to the ideal capacity of a road.
If \textit{Density} is available then \textit{TrafficLevel} is expressed as a dictionary $\circledvee \; : \; \{M, S\} \times \{M, S\} \rightarrow [0, 1]$, where M/S are Main/Side nodes, otherwise as a single $\circledwedge \; : \; [0,1]$ value.
The possible values are Zero (0.0), Low (0.05), Medium (0.2), High (0.5), Very High (0.8), Ridiculous (1.0)

\begin{table}[H]
  \captionof{table}{Enumeration of traffic types}
  \label{tbl:traffic-types}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|l|c|c|c|c|}
      \hline
      \textbf{ID}         & \textbf{Description}                                                  & \textbf{Symmetry} & \textbf{Density} & \textbf{Direction} & \textbf{TrafficLevel}   \\
      \hline
      Random     & Random traffic in all directions                             & \cmark   & \xmark  & \cmark    & \CoarseGrained \\
      \hline
      Stable     & Stable traffic                                               & \cmark   & \cmark  & \cmark    & \FineGrained   \\
      \hline
      Unstable   & Traffic with frequent interruptions from secondary axes      & \cmark   & \cmark  & \cmark    & \FineGrained   \\
      \hline
      Transition & \makecell[l]{Traffic that starts as $C_1$ and ends as $C_2$} & -        & -       & -         & -              \\
      \hline
    \end{tabular}
  }
\end{table}

\paragraph{The traffic registry}

Using the above classification, a traffic registry can be assembled so that traffic can be generated a\`-a-carte.
In order to create realistic scenarios, a set of \textit{four} situations has been developed.

\subparagraph{Normal}

All in order: those who take the train take the train, those who take public transit take public transit, those who take the car take the car.
No disruptions are expected.
Weekday traffic is more heavily influenced by commuters for work/study, so the main routes are more affected.
On the other hand, during holiday traffic, people who travel not for "duty" but for "pleasure" will also travel to smaller destinations.
Especially during holiday traffic, commuter traffic is usually minimal, and any out-of-towners (especially those traveling medium distances, e.g., Milan <-> PC) have returned home in the previous days (usually Friday evening).
The components of this traffic set are listed in Table \ref{tbl:traffic-set-normal}.

\begin{table}[H]
  \captionof{table}{Enumeration of "Normal" traffic set}
  \label{tbl:traffic-set-normal}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|l|l|}
      \hline
      \textbf{ID}    & \textbf{Description}                                             & \textbf{Classification} \\
      \hline
      N1    & Weekday/holiday traffic during off-peak hours           & Random Symmetric Low \\
      \hline
      N2    & Weekday traffic during peak hours (center <- outskirts) & Stable Asymmetric Direct Dense <Medium, Low, Low, Low> \\
      \hline
      N3    & Weekday traffic during peak hours (center -> outskirts) & Stable Asymmetric Inverse Dense <Medium, Low, Low, Low> \\
      \hline
      N4    & Holiday traffic during peak hours (center <- outskirts) & Unstable Asymmetric Direct Dense <Medium, Low, Low, Low> \\
      \hline
      N5    & Holiday traffic during peak hours (center -> outskirts) & Unstable Asymmetric Inverse Dense <Medium, Low, Low, Low> \\
      \hline
      N1-N2 & Weekday morning traffic, increasing                     & Transition >N1>>N2> \\
      \hline
      N1-N3 & Weekday evening traffic, increasing                     & Transition >N1>>N3> \\
      \hline
      N2-N1 & Weekday morning traffic, decreasing                     & Transition >N2>>N1> \\
      \hline
      N3-N1 & Weekday evening traffic, decreasing                     & Transition >N3>>N1> \\
      \hline
      N1-N4 & Holiday morning traffic, increasing                     & Transition >N1>>N4> \\
      \hline
      N1-N5 & Holiday evening traffic, increasing                     & Transition >N1>>N5> \\
      \hline
      N4-N1 & Holiday morning traffic, decreasing                     & Transition >N4>>N1> \\
      \hline
      N5-N1 & Holiday evening traffic, decreasing                     & Transition >N5>>N1> \\
      \hline
    \end{tabular}
  }
\end{table}

\subparagraph{Railway Strike}

People who normally take the best means of transportation for medium to long distances will now travel by car.
This will lead to increased traffic on the main route at all hours and increased travel during off-peak hours to try to escape the expected congestion.
Likewise, commuter drivers will try different routes or schedules, experiencing increased traffic in all directions, even during off-peak hours.
This type of strike usually doesn't significantly impact holiday traffic, as out-of-towners or tourists prefer to move their departures earlier or later or rely on chance, hoping their train isn't canceled.
The components of this traffic set are listed in Table \ref{tbl:traffic-set-railway-strike}.

\begin{table}[H]
  \captionof{table}{Enumeration of "Railway Strike" traffic set}
  \label{tbl:traffic-set-railway-strike}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|l|l|}
      \hline
      \textbf{ID}      & \textbf{Description}                                                                & \textbf{Classification} \\
      \hline
      ST1     & Weekday traffic during off-peak hours on train strike days                 & Random Symmetric Medium \\
      \hline
      ST2     & Weekday traffic during peak hours (center <- suburbs) on train strike days & Stable Asymmetric Direct Dense <High,Low,Low,Low> \\
      \hline
      ST3     & Weekday traffic during peak hours (center -> suburbs) on train strike days & Stable Asymmetric Inverse Dense <High,Low,Low,Low> \\
      \hline
      ST1-ST2 & Weekday morning traffic on train strike days                               & Transition >ST1>>ST2> \\
      \hline
      ST1-ST3 & Weekday evening traffic on train strike days                               & Transition >ST1>>ST3> \\
      \hline
      ST2-ST1 & Weekday morning traffic decreasing on train strike days                    & Transition >ST2>>ST1> \\
      \hline
      ST3-ST1 & Weekday evening traffic decreasing on train strike days                    & Transition >ST3>>ST1> \\
      \hline
    \end{tabular}
  }
\end{table}

\subparagraph{Public Transit Strike}

The same considerations regarding the train strike apply, with some differences.
People who normally take local public transit will now travel by car.
This includes not only those arriving by train, but also those who already live in the province or city.
Therefore, there will be much more traffic to and from smaller destinations.
The components of this traffic set are listed in Table \ref{tbl:traffic-set-public-transit-strike}.

\begin{table}[H]
  \captionof{table}{Enumeration of "Public Transit Strike" traffic set}
  \label{tbl:traffic-set-public-transit-strike}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|l|l|}
      \hline
      \textbf{ID}          & \textbf{Description}                                                                                     & \textbf{Classification} \\
      \hline
      STPL1       & Weekday traffic during off-peak hours on days of local public transit strikes                 & Random Symmetric Medium \\
      \hline
      STPL2       & Weekday traffic during peak hours (center <- suburbs) on days of local public transit strikes & Stable Asymmetric Direct Dense <High,Medium,Medium,Medium> \\
      \hline
      STPL3       & Weekday traffic during peak hours (center -> suburbs) on days of local public transit strikes & Stable Asymmetric Inverse Dense <High,Medium,Medium,Medium> \\
      \hline
      STPL1-STPL2 & Weekday morning traffic during off-peak hours on days of local public transit strikes         & Transition >STPL1>>STPL2> \\
      \hline
      STPL1-STPL3 & Weekday evening traffic increasing on local public transit strike days                        & Transition >STPL1>>STPL3> \\
      \hline
      STPL2-STPL1 & Weekday morning traffic decreasing on local public transit strike days                        & Transition >STPL2>>STPL1> \\
      \hline
      STPL3-STPL1 & Weekday evening traffic decreasing on local public transit strike days                        & Transition >STPL3>>STPL1> \\
      \hline
    \end{tabular}
  }
\end{table}

\subparagraph{Tramway Roadworks}

Traffic on the main roads (affected by the groundwork for the tram project) has been modified to drastically reduce the number of vehicles allowed to use them.
Consequently, a significant number of motorists are forced to take detours (on secondary roads) to bypass the construction sites.
Construction sites, unlike strikes, impact traffic even on holidays (especially during major events such as concerts and sporting competitions).
The components of this traffic set are listed in Table \ref{tbl:traffic-set-tramway-roadworks}.

\begin{table}[H]
  \captionof{table}{Enumeration of "Tramway Roadworks" traffic set}
  \label{tbl:traffic-set-tramway-roadworks}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|l|l|l|}
    \hline
    \textbf{ID}      & \textbf{Description}                                                                               & \textbf{Classification} \\
    \hline
    CT1     & Weekday/holiday traffic during off-peak hours on days with tram construction              & Unstable Symmetric Dense <Low,Low,Low,Low> \\
    \hline
    CT2     & Weekday traffic during peak hours (city center <- suburbs) on days with tram construction & Stable Asymmetric Direct Dense <Low,Medium,Medium,Low> \\
    \hline
    CT3     & Weekday traffic during peak hours (city center -> suburbs) on days with tram construction & Stable Asymmetric Inverse Dense <Low,Medium,Medium,Low> \\
    \hline
    CT4     & Holiday traffic during peak hours (city center <- suburbs) on days with tram construction & Unstable Asymmetric Direct Dense <Low,Medium,Medium,Low> \\
    \hline
    CT5     & Holiday traffic during peak hours (center -> suburbs) on days with tram construction      & Unstable Asymmetric Inverse Dense <Low,Medium,Medium,Low> \\
    \hline
    CT1-CT2 & Weekday morning traffic on days with tram construction                                    & Transition >CT1>>CT2> \\
    \hline
    CT1-CT3 & Weekday evening traffic on days with tram construction                                    & Transition >CT1>>CT3> \\
    \hline
    CT2-CT1 & Weekday morning traffic decreasing on days with tram construction                         & Transition >CT2>>CT1> \\
    \hline
    CT3-CT1 & Weekday evening traffic decreasing on days with tram construction                         & Transition >CT3>>CT1> \\
    \hline
    CT1-CT4 & Holiday morning traffic on days with tram construction                                    & Transition >CT1>>CT4> \\
    \hline
    CT1-CT5 & Evening holiday traffic increases on days with tram construction                          & Transition >CT1>>CT5> \\
    \hline
    CT4-CT1 & Morning holiday traffic decreases on days with tram construction                          & Transition >CT4>>CT1> \\
    \hline
    CT5-CT1 & Evening holiday traffic decreases on days with tram construction                          & Transition >CT5>>CT1> \\
    \hline
    \end{tabular}
  }
\end{table}

\paragraph{The traffic specifier}

The traffic generator module accepts as input a string specifier with a special syntax that allows to unleash all the options available.
Each string is a sequence of comma separated arguments.

If the first argument is a number, it is considered to be the number of routes file to be generated.
If the second argument is a number, it is considered to be the duration of a routes file (default is 100000 seconds).

If the character \textit{'$\pounds$'} is present among the arguments, then the traffic flows generated will have artificial queues enabled (implemented with $arrivalSpeed = 0$ to simulate a traffic slowdown at edges).

If the character \textit{'*'} is present among the arguments, then all the entries of the traffic registry which are not Transitions are added as if they were mentioned as arguments.

If the character \textit{'$\sim$'} is present among the arguments, all the added entries are shuffled.

All the other arguments are interpreted as ID of entries of the traffic registry, therefore all the mentioned entries get included in a transition. If only one entry is specified, then it is used as is without being wrapped in a Transition object.

Here are some examples:

\subparagraph{$2,\pounds,N1,N2,N1,N3,N1$}
This string instructs the generator to use a transition $N1 \rightarrow N2 \rightarrow N1 \rightarrow N3 \rightarrow N1$ with artificial queues enabled and generate two $100000$ seconds long routes file.

\subparagraph{$1,400000,\pounds,*,\sim$}
This string instructs the generator to use a transition with all the atomic entries shuffled and concatenated in a single transition (e.g. $N2 \rightarrow CT5 \rightarrow N3 \rightarrow STPL1 \rightarrow STPL2 \rightarrow N4 \rightarrow CT3 \rightarrow CT1 \rightarrow CT4 \rightarrow N1 \rightarrow CT2 \rightarrow ST2 \rightarrow N5 \rightarrow ST1 \rightarrow STPL3 \rightarrow ST3$) with artificial queues enabled and generate one $400000$ seconds long routes file.

\paragraph{Generating datasets}

The module \textbf{generate-datasets} accepts as input a description of a dataset to be generated with a name and the traffic specifiers of which it is composed (into distinct sets: training and evaluation).
This is actively used in the experiments to generate the datasets automatically from a seed.

\subsection{Executing experiments}

The \textbf{executor} module allows to perform a series of experiments in an unattended fashion.
In Figure \ref{fig:executor-architecture} the architecture of the executor is shown.

The Executor class loads a list of Experiment instances which can be launched by ID.
Each Experiment has an \textit{ID}, a \textit{name} and two boolean values which allow a custom experiment to skip training or evaluation phases if needed (e.g. fixed cycle agents don't require training).
The Experiment instance also need an access to the singleton Archive instance.
The Archive class enables an experiment to switch context from one Configuration to another in order to run different configurations SUMO-RL in the same experiment.

A Configuration instance has multiple attributes which reflect the options passed to the SUMO-RL core module.
For each run it is possible to configure the agent, the observation function, the reward function, the dataset used, the number of quantization levels.
It is also possible to enable the Self Adaptive mechanism, to shutdown the controlled intersection so that they behave like precedence based intersections and the partition type (which if enabled allows an agent to control more than one traffic light intersection at the same time).

The Configuration object also has an \textit{hash()} method which is used to give a name to the active configuration.
This is realized simply by, more or less, concatenating the attribute values separated by a dash symbol ('-').
An example of such naming is \textit{dql-mono-d-dwt-nsa-dataset\_zero-on-q8}.
While that seems verbose, it is very effective in allowing to distinguish between configurations.

For each experiment a subclass of the Experiment class should be created.
In particular, two more advanced base classes have been created in order to automate two useful behaviors.

The CombinatorialExperiment class implements an experiment in which for each possible combination of the supplied options (its attributes are list of option values) it executes one round of training with SUMO-RL and then it executes $5$ rounds of evaluation.
During this last phase the analysis modules introduced in the next subsection are called in order to produce a final deliverable with a dataframe of metrics containing all the combinations as rows for each evaluation round.

The SerialExperiment class is very similar to the CombinatorialExperiment class with the exception than the configurations used are directly supplied in a list of configuration as attribute of the instance.

\putimage{figures/executor-architecture.png}{The Executor architecture}{fig:executor-architecture}{1.0}

\subsection{Analyzing experiment runs}

\paragraph{The raw material}

During a training or evaluation round, the SUMO-RL Core tracks down some metrics which can be useful to evaluate the goodness of the reinforcement learning system.
It writes them to metrics file in the output directory, an example of which is displayed in Table \ref{tbl:metrics-file-example}.
For conciseness, the metrics are enumerated by acronyms, but in those files are listed by full name.
These are the same metrics that have been presented in the previous section.

\begin{table}[H]
  \captionof{table}{Example of metrics file produced by SUMO-RL Core}
  \label{tbl:metrics-file-example}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|c|c|c|c|c|c|c|c|c|c|c|c|c|}
      \hline
      \textbf{Step} & \textbf{TR} & \textbf{TB} & \textbf{TS} & \textbf{TA} & \textbf{TD} & \textbf{TT} & \textbf{TWT} & \textbf{MWT} & \textbf{TAWT} & \textbf{MAWT} & \textbf{MS} & \textbf{TR} \\
      \hline
      0.0 & 0 & 0 & 0 & 0 & 0 & 0 & 0.0 & 0 & 0.0 & 0 & 11.568 & 0.0 \\
      \hline
      5.0 & 28 & 71 & 0 & 0 & 28 & 0 & 0.0 & 0.0 & 0.0 & 0.0 & 10.622 & 0.0 \\
      \hline
      10.0 & 42 & 0 & 0 & 0 & 42 & 0 & 0.0 & 0.0 & 0.0 & 0.0 & 11.128 & 0.0 \\
      \hline
      15.0 & 42 & 0 & 0 & 0 & 42 & 0 & 0.0 & 0.0 & 2.0 & 0.047 & 11.114 & 0.0 \\
      \hline
      20.0 & 42 & 0 & 0 & 0 & 42 & 0 & 0.0 & 0.0 & 2.0 & 0.047 & 11.257 & -0.02 \\
      \hline
      25.0 & 41 & 0 & 2 & 1 & 42 & 0 & 4.0 & 0.097 & 6.0 & 0.146 & 10.519 & -0.03 \\
      \hline
      30.0 & 44 & 0 & 6 & 1 & 45 & 0 & 20.0 & 0.454 & 27.0 & 0.613 & 10.579 & -0.170 \\
      \hline
      35.0 & 43 & 0 & 7 & 2 & 45 & 0 & 49.0 & 1.139 & 56.0 & 1.302 & 11.210 & -0.33 \\
      \hline
      ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
      \hline
    \end{tabular}
  }
\end{table}

\paragraph{Extracting metrics}

A module \textbf{extract-global-metrics} can retrieve all the metrics file produced by an experiment organized in iterations (e.g. \textit{0.csv, 1.csv, 2.csv}) and by phase (evaluation or training).
It produces a summarizing dictionary with minimum value, maximum value, mean and variance for each metric.
An example is displayed in Listing \ref{lst:metrics-global-extraction-example}.
It has been programmed to do so only for evaluation metrics, since the training metrics will be subject of another type of analysis.

A variant of this module, \textbf{extract-directional-metrics}, does the same kind of extraction but further divides data into the directions of the network (e.g. \textit{J2-J0, J2-J1, J2-J3}).
In order to do so, SUMO-RL Core have to be launched with the \textit{-de, --depth} option.
This analysis allows to verify if the agents ensure fairness among all the users of the road network.

\noindent
\begin{minipage}{\linewidth}
\begin{lstlisting}[language=JSON, caption=Example of dictionary of metrics extracted from the metric files, label={lst:metrics-global-extraction-example}]
  {
    'waiting_time': {
      'mean': np.float64(48.299),
      'var': np.float64(837.112),
      'min': np.float64(0.0),
      'max': np.float64(126.426)
    }, 'accumulated_waiting_time': {
      'mean': np.float64(140.083),
      'var': np.float64(6865.645),
      'min': np.float64(0.0),
      'max': np.float64(268.278)
    }, 'speed': {
      'mean': np.float64(9.942),
      'var': np.float64(0.112),
      'min': np.float64(9.015),
      'max': np.float64(11.257)
    }, 'arrival_rate': {
      'mean': np.float64(3.096),
      'var': np.float64(3.200),
      'min': np.int64(0),
      'max': np.int64(9)},
    'departure_rate': {
      'mean': np.float64(4.163),
      'var': np.float64(8.420),
      'min': np.int64(0),
      'max': np.int64(22)
    }
  }
\end{lstlisting}
\end{minipage}

\paragraph{Comparing configurations}

The output of the \textit{extract-global/directional-metrics} utilities is stored in a \textit{scores.yml} file inside the output directory.
Since with the Executor module each experiment is run in a separate context, a module, \textbf{compare-metrics}, has been implemented in order to aggregate all the \textit{scores.yml} files into a single round csv file comprising metrics for all the configuration, as shown in Table \ref{tbl:round-file-example}.

\begin{table}[H]
  \captionof{table}{Example of round file produced by \textit{compare-metrics}}
  \label{tbl:round-file-example}
  \resizebox{\linewidth}{!}{
    \begin{tabular}{|c|c|c|c|c|c|}
      \hline
      \textbf{ID} & \textbf{AWT max} & \textbf{AWT mean} & \textbf{AWT min} & \textbf{AWT var} & ... \\
      \hline
      a & 913.785 & 205.417 & 0.0 & 19569.804 & ... \\
      \hline
      b & 878.5   & 210.828 & 0.0 & 20006.516 & ... \\
      \hline
      c & 914.211 & 396.977 & 0.0 & 13184.152 & ... \\
      \hline
      d & 903.75  & 206.176 & 0.0 & 19920.849 & ... \\
      \hline
      e & 877.0   & 210.703 & 0.0 & 21200.319 & ... \\
      \hline
    \end{tabular}
  }
\end{table}

\paragraph{Generating automated reports}

Starting from these round files, the module \textbf{generate-report} is able to produce three distinct valuable deliverables.
For each metric it creates a plot showing the value of the metric over time (= over rounds) for each configuration variant.
An example is shown in Figure \ref{fig:generate-report-plots}.
Then it produces another plot for each metric averaging the value of the metric over time and showing a barplot of all the configurations.
An example is shown in Figure \ref{fig:generate-report-bars}.

The utility is also able to generate radar shaped plots which compare different configurations by their mean metric values, as shown in Figure \ref{fig:generate-report-radars}.
Curves depicted in such graphs always indicate a positive quantity, in other words: higher is better.
This rescaling is obtained by inverting the value of the "negative" metrics such as waiting time, leaving unvaried "positive" metrics such as average speed.
A further normalization is performed to obtain values in range $[0,\;1]$ which resemble the relative proportions between values of the same metric for different configurations.
The usual interpretation of such graph is that to a larger curve corresponds a better configuration (and of course, a smaller curve coincides with a worse configuration).

Finally, it assigns some points (computed using a Fibonacci sequence) to all the configuration on the basis of how well that metric value is with respect of the ones achieved by the other metrics.
For this evaluation, the average over time is used.
Summing all the leaderboard created for each metric, \textit{generate-report} creates also a final leaderboard.
Each leaderboard get plotted in a separated file for the sake of comparison.

An example is shown in Figure \ref{fig:generate-report-leaderboards}.
While a leaderboard system isn't exhaustive in evaluating the relative goodness of those configurations, it gives a quick insight of the results.
It is however important to inspect the other deliverables to ensure that an advantage in terms of points is reflecting a clear superiority in terms of metrics.
Otherwise, a slight metric difference would lead to an unfair advantage.

\putimagecouple
{\putsubimage{figures/generate-report-bars.png}{An example of Bar plot created by the generate-report utility}{fig:generate-report-bars}{0.45}{1.0}}
{\putsubimage{figures/generate-report-leaderboards.png}{An example of Leaderboard plot created by the generate-report utility}{fig:generate-report-leaderboards}{0.45}{1.0}}
\putimage{figures/generate-report-plots.png}{An example of metrics plot created by the generate-report utility}{fig:generate-report-plots}{0.75}
\putimage{figures/generate-report-radars.png}{An example of metrics radar created by the generate-report utility}{fig:generate-report-radars}{0.75}

\paragraph{Visualizing raw metrics}

Finally, the modules \textbf{plot-global-metrics} and \textbf{plot-directional-metrics} are a set of utilities for plotting the extracted metrics like mean waiting time, accumulated reward (\textit{total\_reward-AC}), mean speed and so on.
The plots are organized by phase (training and evaluation), by metric. For each simulation, a distinct figure is generated (e.g. \textit{0.png, 1.png, 2.png}) and a concatenated version of all simulation metrics is created as well (\textit{summary.png}).

Moreover, they also create a version of those plots with moving average with two different modes of operation.
The \textit{Symmetric} (SS) moving average maps an input shape of $\mathbb{R}^N$ to an output shape $\mathbb{R}^N$ where each entry $r_i$ is the average of a neighbourhood of length $K$ ($[\frac K 2 - i \; : \; \frac K 2 + i]$).
The \textit{Asymmetric} (AS) moving average maps an input shape of $\mathbb{R}^N$ to an output shape $\mathbb{R}^M$ (with $M \leq N$) where each entry $r_i$ is the average of the right-end neighbourhood of length $K$ ($[i \; : \; K + i]$).

Some examples of plots created by these modules are shown in Figures \ref{fig:plotting-metrics-raw}, \ref{fig:plotting-metrics-ac}, \ref{fig:plotting-metrics-as}, \ref{fig:plotting-metrics-ss}.

\putimage{figures/plotting-metrics-raw.png}{An example of raw metric plotted by \textit{plot-global-metrics}}{fig:plotting-metrics-raw}{0.75}
\putimage{figures/plotting-metrics-ac.png}{An example of accumulated (AC) metric plotted by \textit{plot-global-metrics}}{fig:plotting-metrics-ac}{0.75}

\putimage{figures/plotting-metrics-ss.png}{An example of symmetric smoothed (SS) metric plotted by \textit{plot-global-metrics}}{fig:plotting-metrics-ss}{0.75}
\putimage{figures/plotting-metrics-as.png}{An example of asymmetric smoothed (AS) metric plotted by \textit{plot-global-metrics}}{fig:plotting-metrics-as}{0.75}
